services:
  # SANE daemon for network SANE protocol
  saned:
    build: ./saned
    container_name: saned
    restart: unless-stopped
    privileged: true
    network_mode: host
    volumes:
      - /dev/bus/usb:/dev/bus/usb
    environment:
      - ALLOWED_NETWORK=${ALLOWED_NETWORK}
      - SECONDARY_NETWORK=${SECONDARY_NETWORK:-}
      - SANE_DEBUG_LEVEL=${SANE_DEBUG_LEVEL:-1}
      - SANE_DEBUG_DLL=${SANE_DEBUG_LEVEL:-1}
      - SANE_DEBUG_EPSON2=${SANE_DEBUG_LEVEL:-1}
    healthcheck:
      test: ["CMD", "scanimage", "-L"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # AirSane for AirScan/eSCL protocol  
  airsane:
    image: aguslr/airsane:latest
    container_name: airsane
    restart: unless-stopped
    privileged: true
    network_mode: host
    volumes:
      - /dev/bus/usb:/dev/bus/usb
      - ./airsane/airsane.conf:/etc/airsane/airsane.conf:ro
    environment:
      - AIRSANE_INTERFACE=0.0.0.0
      - AIRSANE_PORT=${AIRSANE_PORT:-8090}
      - AIRSANE_DEBUG=true
      - SANE_DEBUG_DLL=${SANE_DEBUG_LEVEL:-1}
      - SANE_DEBUG_EPSON2=${SANE_DEBUG_LEVEL:-1}
    healthcheck:
      test: ["CMD", "scanimage", "-L"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ScanServJS for web interface
  scanservjs:
    build: ./scanservjs
    container_name: scanservjs  
    restart: unless-stopped
    privileged: true
    ports:
      - "${SCANSERVJS_PORT:-8080}:8080"
    volumes:
      - /dev/bus/usb:/dev/bus/usb
      - ./scanservjs/config.json:/app/config/config.json:ro
      - ./scanservjs/config.local.js:/app/config/config.local.js:ro
      - ./scanservjs/data:/app/data/output
      - ./.env:/.env:ro
    environment:
      - SCANIMAGE_LIST_IGNORE=test
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/Los_Angeles}
      - SANE_DEBUG_DLL=${SANE_DEBUG_LEVEL:-1}
      - SANE_DEBUG_EPSON2=${SANE_DEBUG_LEVEL:-1}
      # SMB Configuration
      - SMB_ENABLED=${SMB_ENABLED:-false}
      - SMB_SERVER=${SMB_SERVER:-}
      - SMB_SHARE=${SMB_SHARE:-}
      - SMB_USER=${SMB_USER:-}
      - SMB_PASS=${SMB_PASS:-}
      - SMB_DOMAIN=${SMB_DOMAIN:-}
      # Email Configuration
      - EMAIL_ENABLED=${EMAIL_ENABLED:-false}
      - SMTP_SERVER=${SMTP_SERVER:-}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USER=${SMTP_USER:-}
      - SMTP_PASS=${SMTP_PASS:-}
      - EMAIL_FROM=${EMAIL_FROM:-}
      - EMAIL_TO=${EMAIL_TO:-}
      - EMAIL_SUBJECT=${EMAIL_SUBJECT:-Scanned Document}
    healthcheck:
      test: ["CMD", "scanimage", "-L"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
